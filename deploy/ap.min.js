//============================================================
//
// Copyright (C) 2012 Matthew Wagerfield
//
// Twitter: https://twitter.com/mwagerfield
//
// Permission is hereby granted, free of charge, to any
// person obtaining a copy of this software and associated
// documentation files (the "Software"), to deal in the
// Software without restriction, including without limitation
// the rights to use, copy, modify, merge, publish, distribute,
// sublicense, and/or sell copies of the Software, and to
// permit persons to whom the Software is furnished to do
// so, subject to the following conditions:
//
// The above copyright notice and this permission notice
// shall be included in all copies or substantial portions
// of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY
// OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
// LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
// FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO
// EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE
// FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
// AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE
// OR OTHER DEALINGS IN THE SOFTWARE.
//
//============================================================

var AP=AP||{};AP.Array=typeof Float32Array=="function"?Float32Array:Array,AP.Math={ETQ:Math.PI/360,DTR:Math.PI/180,RTD:180/Math.PI,degreesToRadians:function(a){return a*this.DTR},radiansToDegrees:function(a){return a*this.RTD}},AP.Matrix={create:function(){var a=new AP.Array(16);return this.identity(a),a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},clone:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},multiply:function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return a[0]=s*c+t*g+u*k+v*o,a[1]=s*d+t*h+u*l+v*p,a[2]=s*e+t*i+u*m+v*q,a[3]=s*f+t*j+u*n+v*r,a[4]=w*c+x*g+y*k+z*o,a[5]=w*d+x*h+y*l+z*p,a[6]=w*e+x*i+y*m+z*q,a[7]=w*f+x*j+y*n+z*r,a[8]=A*c+B*g+C*k+D*o,a[9]=A*d+B*h+C*l+D*p,a[10]=A*e+B*i+C*m+D*q,a[11]=A*f+B*j+C*n+D*r,a[12]=E*c+F*g+G*k+H*o,a[13]=E*d+F*h+G*l+H*p,a[14]=E*e+F*i+G*m+H*q,a[15]=E*f+F*j+G*n+H*r,a},translate:function(a,b,c,d,e){return this.identity(b),b[12]=c,b[13]=d,b[14]=e,this.multiply(a,b),a},scale:function(a,b,c,d,e){return this.identity(b),b[0]=c,b[5]=d,b[10]=e,this.multiply(a,b),a}},AP.Quaternion={create:function(){var a=new AP.Array(4);return this.identity(a),a},identity:function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},clone:function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},multiply:function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=g*h+d*k+e*j-f*i,a[1]=g*i-d*j+e*k+f*h,a[2]=g*j+d*i-e*h+f*k,a[3]=g*k-d*h-e*i-f*j,a},fromEuler:function(a,b,c,d){var e=b*AP.Math.ETQ,f=c*AP.Math.ETQ,g=d*AP.Math.ETQ,h=Math.cos(e),i=Math.sin(e),j=Math.cos(f),k=Math.sin(f),l=Math.cos(-g),m=Math.sin(-g),n=j*l,o=k*m;return a[0]=n*i+o*h,a[1]=k*l*h+j*m*i,a[2]=j*m*h-k*l*i,a[3]=n*h-o*i,a},toMatrix:function(a,b){AP.Matrix.identity(a);var c=b[0]*b[0],d=b[1]*b[1],e=b[2]*b[2],f=b[3]*b[3],g=b[0]*2,h=b[1]*2,i=b[3]*2,j=b[1]*g,k=b[2]*g,l=b[2]*h,m=b[0]*i,n=b[1]*i,o=b[2]*i;return a[0]=f+c-d-e,a[1]=j-o,a[2]=k+n,a[4]=j+o,a[5]=f-c+d-e,a[6]=l-m,a[8]=k-n,a[9]=l+m,a[10]=f-c-d+e,a}},AP.Scene=function(a,b){this.origin={x:0,y:0},this.children=[],this._rotationAngle=0,this._sinRotation=0,this._cosRotation=0,this._pitchAngle=0,this._pitchRatio=0,this._yRatio=0,this.pitch(typeof a=="number"?a:35),this.rotate(typeof b=="number"?b:45)},AP.Scene.prototype={type:"scene",pitch:function(a){this._pitchAngle=AP.Math.degreesToRadians(a),this._pitchRatio=Math.sin(this._pitchAngle),this._yRatio=Math.cos(this._pitchAngle)},rotate:function(a){this._rotationAngle=AP.Math.degreesToRadians(a),this._sinRotation=Math.sin(this._rotationAngle),this._cosRotation=Math.cos(this._rotationAngle)},setOrigin:function(a,b){return this.origin.x=a,this.origin.y=b,this.origin},addChild:function(a){if(!~this.children.indexOf(a)&&a.type===AP.Node.prototype.type){this.children.push(a),a.parent=this;var b=this,c=function(a){a.scene=b;for(var d=0,e=a.children.length;d<e;d++)c(a.children[d])};c(a)}return a},removeChild:function(a){if(~this.children.indexOf(a)){this.children.splice(this.children.indexOf(a),1),a.parent=null;var b=function(a){a.scene=null;for(var c=0,d=a.children.length;c<d;c++)b(a.children[c])};b(a)}return a},projectNodes:function(){var a=function(b){b.project(!1);for(var c=0,d=b.children.length;c<d;c++)a(b.children[c])};for(var b=0,c=this.children.length;b<c;b++)a(this.children[b])},sortNodes:function(){var a,b,c=[],d=function(a){c.push(a);for(var b=0,e=a.children.length;b<e;b++)d(a.children[b])};for(a=0,b=this.children.length;a<b;a++)d(this.children[a]);var e=function(a,b){if(a.zDepth<b.zDepth)return-1;if(a.zDepth>b.zDepth)return 1;if(a.zDepth===b.zDepth)return a.zPriority<b.zPriority?-1:a.zPriority>b.zPriority?1:0};c.sort(e);for(a=0,b=c.length;a<b;a++)c[a].zIndex=a;return c}},AP.Node=function(a){this.id=a,this.scene=null,this.parent=null,this.children=[],this.px=0,this.py=0,this.vx=0,this.vy=0,this.vz=0,this.zPriority=0,this.zOffset=0,this.zDepth=0,this.zIndex=0,this.x=0,this.y=0,this.z=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this.localRotation=!1,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this._matrix=AP.Matrix.create(),this._quaternion=AP.Quaternion.create(),this._ms1=AP.Matrix.create(),this._qs1=AP.Quaternion.create(),this._qs2=AP.Quaternion.create()},AP.Node.prototype={type:"node",reset:function(){this.px=0,this.py=0,this.vx=0,this.vy=0,this.vz=0,this.zIndex=0,this.x=0,this.y=0,this.z=0,this.scaleX=1,this.scaleY=1,this.scaleZ=1,this._rotationX=0,this._rotationY=0,this._rotationZ=0,this.zDepth=0,AP.Matrix.identity(this._matrix),AP.Quaternion.identity(this._quaternion)},translate:function(a,b,c){this.x=a,this.y=b,this.z=c},scale:function(a,b,c){this.scaleX=a,this.scaleY=b,this.scaleZ=c},rotate:function(a,b,c){if(this.localRotation){var d=a-this._rotationX,e=b-this._rotationY,f=c-this._rotationZ;AP.Quaternion.fromEuler(this._qs1,d,e,f),AP.Quaternion.clone(this._quaternion,this._qs2),AP.Quaternion.multiply(this._quaternion,this._qs1,this._qs2)}else AP.Quaternion.fromEuler(this._quaternion,a,b,c);this._rotationX=a,this._rotationY=b,this._rotationZ=c},addChild:function(a){if(!~this.children.indexOf(a)&&a.type===this.type){this.children.push(a),a.parent=this;var b=this.scene,c=function(a){a.scene=b;for(var d=0,e=a.children.length;d<e;d++)c(a.children[d])};c(a)}return a},removeChild:function(a){if(~this.children.indexOf(a)){this.children.splice(this.children.indexOf(a),1),a.parent=null;var b=function(a){a.scene=null;for(var c=0,d=a.children.length;c<d;c++)b(a.children[c])};b(a)}return a},project:function(a){a=typeof a=="boolean"?a:!0,AP.Matrix.identity(this._matrix);if(a){var b=this.parent,c=[this,b],d=b===null,e=null;while(!d&&b.type!==AP.Scene.prototype.type)b=b.parent,d=b===null,c.push(b);if(d)throw"node has not been added to a scene.";for(var f=c.length-2;f>=0;f--)e=c[f],AP.Matrix.translate(this._matrix,this._ms1,e.x,e.y,e.z),AP.Quaternion.toMatrix(this._ms1,e._quaternion),AP.Matrix.multiply(this._matrix,this._ms1),AP.Matrix.scale(this._matrix,this._ms1,e.scaleX,e.scaleY,e.scaleZ)}else this.parent.type===this.type&&AP.Matrix.clone(this.parent._matrix,this._matrix),AP.Matrix.translate(this._matrix,this._ms1,this.x,this.y,this.z),AP.Quaternion.toMatrix(this._ms1,this._quaternion),AP.Matrix.multiply(this._matrix,this._ms1),AP.Matrix.scale(this._matrix,this._ms1,this.scaleX,this.scaleY,this.scaleZ);this.px=this.py=this.zDepth=0,this.vx=this._matrix[12],this.vy=this._matrix[13],this.vz=this._matrix[14],this.px+=this.vx*this.scene._cosRotation,this.py+=this.vx*this.scene._sinRotation,this.px-=this.vz*this.scene._sinRotation,this.py+=this.vz*this.scene._cosRotation,this.py*=this.scene._pitchRatio,this.py-=this.vy*this.scene._yRatio,this.zDepth+=this.vx*this.scene._sinRotation,this.zDepth+=this.vz*this.scene._cosRotation,this.zDepth*=this.scene._yRatio,this.zDepth+=this.vy*this.scene._pitchRatio,this.zDepth+=this.zOffset,this.px+=this.scene.origin.x,this.py+=this.scene.origin.y}},Object.defineProperties(AP.Node.prototype,{rotationX:{enumerable:!0,get:function(){return this._rotationX},set:function(a){this.rotate(a,this._rotationY,this._rotationZ)}},rotationY:{enumerable:!0,get:function(){return this._rotationY},set:function(a){this.rotate(this._rotationX,a,this._rotationZ)}},rotationZ:{enumerable:!0,get:function(){return this._rotationZ},set:function(a){this.rotate(this._rotationX,this._rotationY,a)}}})